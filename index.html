<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Focus Hub</title>
<meta name="theme-color" content="#10261f" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Focus Hub">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
  /* ========= Palette tuned to your greens ========= */
  :root{
    --bg: #10261f;                /* deep green */
    --grid-line: rgba(255,255,255,.06);
    --surface: #132e25;           /* dark card */
    --text: #e7efe9;
    --muted: #a7b9ae;
    --accent: #98e0b1;            /* mint highlight */
    --accent-strong: #6bc38f;
    --ok: #aee6bd;
    --warn: #ffd699;
    --danger: #ff6b6b;

    /* category colors (harmonised) */
    --cat-housework: #98e0b1;     /* mint */
    --cat-etsy: #f3c5ac;          /* soft peach */
    --cat-freelance: #9bc7b9;     /* seafoam */
    --cat-personal: #e1f4d8;      /* pale green */
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#e7efe9;
      --grid-line: rgba(16,38,31,.08);
      --surface:#ffffff;
      --text:#0d1814;
      --muted:#476456;
      --accent:#1e8e61;
      --accent-strong:#166e4b;
    }
  }

  /* ========= Typography ========= */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.35 "Gill Sans", "Gill Sans MT", "Gill Sans Nova", Calibri, "Trebuchet MS", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    /* grid paper background */
    background:
      repeating-linear-gradient(0deg, var(--grid-line) 0, var(--grid-line) 1px, transparent 1px, transparent 16px),
      repeating-linear-gradient(90deg, var(--grid-line) 0, var(--grid-line) 1px, transparent 1px, transparent 16px),
      var(--bg);
  }

  .app{max-width:720px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;}

  header{position:sticky;top:0;z-index:10;background:transparent;padding:12px 16px 8px;backdrop-filter:saturate(140%) blur(2px)}
  .title{
    font-weight:700; letter-spacing:.08em; text-transform:uppercase;
    display:flex; align-items:center; gap:10px
  }
  .title .dot{width:10px; height:10px; border-radius:50%; background:var(--accent)}
  .subtitle{color:var(--muted); font-size:13px; margin-top:2px; letter-spacing:.06em; text-transform:uppercase}

  .tabs{
    display:flex; gap:8px; margin-top:12px;
  }
  .tab{
    flex:1; text-align:center; padding:12px 10px; border-radius:12px;
    background:linear-gradient(180deg, rgba(152,224,177,.10), rgba(152,224,177,.06));
    color:var(--muted); border:1px solid rgba(152,224,177,.25);
    user-select:none; letter-spacing:.08em; text-transform:uppercase; font-weight:700;
  }
  .tab[aria-selected="true"]{
    color:var(--text);
    border-color: var(--accent);
    background: linear-gradient(180deg, rgba(152,224,177,.25), rgba(152,224,177,.12));
    outline:2px solid color-mix(in srgb, var(--accent) 35%, transparent);
  }

  main{flex:1; padding:12px 12px 96px}

  .card{background:var(--surface); border:1px solid rgba(152,224,177,.18); border-radius:14px; padding:12px; margin:10px 0}
  .row{display:flex; gap:8px; align-items:center}
  .grow{flex:1}
  input[type="text"], select, input[type="time"], input[type="date"], input[type="number"]{
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid rgba(152,224,177,.25); background:#0c221b; color:var(--text);
  }
  input::placeholder{color:#94a49b}

  button{
    padding:12px 14px; border-radius:12px; border:1px solid rgba(152,224,177,.25); background:#103026; color:var(--text);
    letter-spacing:.08em; text-transform:uppercase; font-weight:700;
  }
  button.primary{border-color:var(--accent); background:color-mix(in srgb, var(--accent) 18%, #103026)}

  .pill{
    display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:7px 10px; border-radius:999px;
    border:1px solid rgba(152,224,177,.25); background:#0f281f; color:var(--muted);
    letter-spacing:.08em; text-transform:uppercase; font-weight:700;
  }

  .list{display:flex; flex-direction:column; gap:8px}

  .todo{display:flex; align-items:flex-start; gap:10px; padding:12px; border:1px solid rgba(152,224,177,.25); border-radius:12px; background:#0e251e}
  .todo.dragging{opacity:.6; outline:2px dashed var(--accent)}
  .todo.done{opacity:.55; text-decoration:line-through}

  .badge{font-size:11px; padding:2px 8px; border-radius:999px; color:#0b0b0c; font-weight:700}
  .badge.housework{background:var(--cat-housework)}
  .badge.etsy{background:var(--cat-etsy)}
  .badge.freelance{background:var(--cat-freelance)}
  .badge.personal{background:var(--cat-personal)}

  .section-tabs{display:flex; gap:8px; margin:8px 0 6px}
  .section-tabs button{flex:1}
  .section-tabs button[aria-pressed="true"]{border-color:var(--accent); background:linear-gradient(180deg, rgba(152,224,177,.22), rgba(152,224,177,.1)); color:var(--text)}

  .muted{color:var(--muted)}
  .small{font-size:12px}
  .spacer{height:8px}

  /* Schedule */
  .schedule-grid{display:flex; flex-direction:column; gap:8px;}
  .block{border:1px solid rgba(152,224,177,.25); background:#0c221b; border-left:6px solid var(--accent-strong); padding:10px; border-radius:10px;}

  /* Habits */
  .habit{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border:1px solid rgba(152,224,177,.25); border-radius:12px; background:#0e251e}
  .streak{font-weight:700}
  .days{display:flex; gap:6px}
  .daycheck{width:28px; height:28px; display:grid; place-items:center; border-radius:8px; border:1px solid rgba(152,224,177,.25); background:#0c221b; color:var(--muted); letter-spacing:.06em; text-transform:uppercase; font-weight:700}
  .daycheck[aria-checked="true"]{background:var(--ok); color:#0b0b0c; border-color:var(--ok)}

  /* Bottom bar */
  nav{position:sticky; bottom:0; z-index:10; background:linear-gradient(180deg, transparent, rgba(0,0,0,.35)); border-top:1px solid rgba(152,224,177,.18); padding:8px 12px;}
  .actions{display:flex; gap:8px}
  .actions > button{flex:1}

  /* Bigger "Add task" input */
  .todo-input-wrap{display:flex; gap:8px; align-items:stretch}
  .todo-input{
    flex:1; padding:16px 16px; font-size:18px; border-radius:12px; border:1px solid rgba(152,224,177,.28); background:#0a1e19; color:var(--text);
  }
  .todo-input::placeholder{color:#97a89f; font-style:italic}
  #todo-cat{min-width:134px}
</style>
</head>
<body>
<div class="app" id="app">
  <header role="banner">
    <div class="title" aria-label="Focus Hub">
      <span class="dot" aria-hidden="true"></span><span>Focus Hub</span>
    </div>
    <div class="subtitle small">Tabs: To-Dos • Schedule • Habits. Data saves locally. Works offline.</div>
    <div class="tabs" role="tablist" aria-label="Main sections">
      <button class="tab" role="tab" id="tab-todos" aria-controls="panel-todos" aria-selected="true" type="button">To-Dos</button>
      <button class="tab" role="tab" id="tab-schedule" aria-controls="panel-schedule" aria-selected="false" type="button">Schedule</button>
      <button class="tab" role="tab" id="tab-habits" aria-controls="panel-habits" aria-selected="false" type="button">Habits</button>
    </div>
  </header>

  <main>
    <!-- TO-DOS -->
    <section id="panel-todos" role="tabpanel" aria-labelledby="tab-todos">
      <div class="card">
        <div class="section-tabs" role="tablist" aria-label="To-Do Buckets">
          <button class="pill" role="tab" data-bucket="today" aria-pressed="true" type="button">Today</button>
          <button class="pill" role="tab" data-bucket="short" aria-pressed="false" type="button">Short Term</button>
          <button class="pill" role="tab" data-bucket="long" aria-pressed="false" type="button">Long Term</button>
        </div>
        <div class="todo-input-wrap">
          <input id="todo-text" class="todo-input" type="text" placeholder="Add a new task…">
          <select id="todo-cat" aria-label="Category">
            <option value="housework">Housework</option>
            <option value="etsy">Etsy</option>
            <option value="freelance">Freelance</option>
            <option value="personal">Personal</option>
          </select>
          <button id="add-todo" class="primary" type="button">Add</button>
        </div>
        <div class="spacer"></div>
        <div class="row small muted">
          <span class="pill"><span class="badge housework"></span> Housework</span>
          <span class="pill"><span class="badge etsy"></span> Etsy</span>
          <span class="pill"><span class="badge freelance"></span> Freelance</span>
          <span class="pill"><span class="badge personal"></span> Personal</span>
        </div>
      </div>
      <div id="todo-list" class="list" aria-live="polite"></div>
    </section>

    <!-- SCHEDULE -->
    <section id="panel-schedule" role="tabpanel" aria-labelledby="tab-schedule" hidden>
      <div class="card">
        <div class="row">
          <input id="sched-title" class="grow" type="text" placeholder="Block title (e.g., Deep work: Etsy)" />
        </div>
        <div class="row">
          <input id="sched-date" type="date" class="grow" />
          <input id="sched-start" type="time" />
          <input id="sched-end" type="time" />
          <select id="sched-cat" aria-label="Category">
            <option value="housework">Housework</option>
            <option value="etsy">Etsy</option>
            <option value="freelance">Freelance</option>
            <option value="personal">Personal</option>
          </select>
          <button id="add-block" class="primary" type="button">Add</button>
        </div>
        <div class="small muted" id="collision-msg" style="display:none;margin-top:6px;">⚠️ Time conflict detected. Blocks are still saved—adjust if needed.</div>
      </div>
      <div class="card">
        <div class="row">
          <input id="sched-date-view" type="date" class="grow" />
          <button id="today-btn" type="button">Today</button>
          <button id="clear-day" title="Remove all blocks for the day" type="button">Clear</button>
        </div>
      </div>
      <div id="schedule-grid" class="schedule-grid" aria-live="polite"></div>
    </section>

    <!-- HABITS -->
    <section id="panel-habits" role="tabpanel" aria-labelledby="tab-habits" hidden>
      <div class="card">
        <div class="row">
          <input id="habit-name" class="grow" type="text" placeholder="New habit (e.g., Morning yoga, No vaping)" />
          <input id="habit-goal" type="number" min="1" max="7" value="5" title="Weekly goal" />
          <button id="add-habit" class="primary" type="button">Add</button>
        </div>
        <div class="small muted">Tap each day to mark it. Weekly goal = target checkmarks Mon–Sun. Streak counts consecutive full-goal weeks.</div>
      </div>
      <div id="habit-list" class="list" aria-live="polite"></div>
    </section>
  </main>

  <nav>
    <div class="actions">
      <button id="export-data" type="button">Export</button>
      <button id="import-data" type="button">Import</button>
      <button id="reset-all" type="button">Reset</button>
    </div>
  </nav>
</div>

<script>
/* --------- State & Utilities ---------- */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const store = {
  load(){
    try{
      return JSON.parse(localStorage.getItem('focushub_v1')) || { todos:{today:[],short:[],long:[]}, schedule:{}, habits:[] };
    }catch{ return { todos:{today:[],short:[],long:[]}, schedule:{}, habits:[] }; }
  },
  save(){ localStorage.setItem('focushub_v1', JSON.stringify(state)); }
};
let state = store.load();

const todayISO = () => new Date().toISOString().slice(0,10);
const pad = n => String(n).padStart(2,'0');
const timeToMinutes = t => { const [h,m] = t.split(':').map(Number); return h*60+m; };
const minutesToTime = m => `${pad(Math.floor(m/60))}:${pad(m%60)}`;
function categoryClass(cat){ return ({housework:'housework', etsy:'etsy', freelance:'freelance', personal:'personal'}[cat]||'personal'); }

/* --------- Tabs (hash-based, iOS-safe) ---------- */
const panels = { 'todos':'panel-todos', 'schedule':'panel-schedule', 'habits':'panel-habits' };
function showTab(name){
  const tabId = 'tab-' + name;
  const panelId = panels[name];
  document.querySelectorAll('.tabs .tab').forEach(b=>{ b.setAttribute('aria-selected', String(b.id === tabId)); });
  document.querySelectorAll('main > section').forEach(sec=>{ sec.hidden = (sec.id !== panelId); });
}
function handleTabClick(e){
  const btn = e.target.closest('.tab'); if(!btn) return;
  const name = btn.id.replace('tab-','');
  if(location.hash !== '#'+name){ history.replaceState(null, '', '#'+name); }
  showTab(name);
}
document.querySelector('.tabs').addEventListener('click', handleTabClick);
window.addEventListener('hashchange', ()=>{
  const name = (location.hash.replace('#','') || 'todos');
  showTab(panels[name] ? name : 'todos');
});
showTab((location.hash.replace('#','') || 'todos'));

/* --------- Quick Add via URL params ---------- */
function parseQuery() {
  const p = new URLSearchParams(location.search);
  if (!p.has('quick')) return null;
  const quick = p.get('quick');
  const normBucket = (v) => (['today','short','long'].includes(v||'') ? v : 'today');
  const normCat = (v) => (['housework','etsy','freelance','personal'].includes(v||'') ? v : 'personal');
  if (quick === 'todo') {
    const text = (p.get('text') || '').trim();
    if (!text) return null;
    return { type: 'todo', text, bucket: normBucket(p.get('bucket')), cat: normCat(p.get('cat')) };
  }
  return null;
}
function handleQuickAdd(q) {
  if (!q) return;
  if (q.type === 'todo') {
    state.todos[q.bucket].push({ id:crypto.randomUUID(), text:q.text, cat:q.cat, done:false, created: Date.now() });
    activeBucket = q.bucket;
    store.save();
    history.replaceState({}, document.title, location.pathname + location.hash);
    const note = document.createElement('div');
    note.textContent = `Added to ${q.bucket}: ${q.text}`;
    Object.assign(note.style,{position:'fixed',left:'50%',bottom:'20px',transform:'translateX(-50%)',background:'#103026',color:'white',padding:'10px 12px',borderRadius:'10px',border:'1px solid rgba(152,224,177,.25)',zIndex:9999});
    document.body.appendChild(note); setTimeout(()=>note.remove(), 1500);
    renderTodos(); showTab('todos');
  }
}

/* --------- To-Dos ---------- */
let activeBucket = 'today';
function renderTodos(){
  $$('.section-tabs button').forEach(b=>{ b.setAttribute('aria-pressed', String(b.dataset.bucket===activeBucket)); });
  const list = $('#todo-list'); list.innerHTML='';
  const items = state.todos[activeBucket];
  if(!items.length){
    const empty = document.createElement('div');
    empty.className='card small muted';
    empty.textContent='No tasks yet. Add one above.';
    list.appendChild(empty);
  } else {
    items.forEach((t,i)=>{
      const el = document.createElement('div'); el.className='todo'+(t.done?' done':''); el.setAttribute('draggable','true'); el.dataset.index=i;
      el.innerHTML = `
        <input type="checkbox" ${t.done?'checked':''} aria-label="Mark done">
        <div class="grow">
          <div>${t.text}</div>
          <div class="small muted">Added ${new Date(t.created).toLocaleString()}</div>
        </div>
        <span class="badge ${categoryClass(t.cat)}">${t.cat[0].toUpperCase()+t.cat.slice(1)}</span>
        <button title="Move" type="button">⋯</button>
        <button title="Delete" type="button">✕</button>
      `;
      const [chk, , , moveBtn, delBtn] = el.querySelectorAll('input, .grow, .badge, button, button');
      chk.addEventListener('change', ()=>{ t.done = chk.checked; store.save(); el.classList.toggle('done', t.done); });
      moveBtn.addEventListener('click', ()=>{
        const options = ['today','short','long'].filter(b=>b!==activeBucket);
        const dest = prompt(`Move to: ${options.join(', ')}`, options[0] || 'today');
        if(dest && state.todos[dest]){ state.todos[activeBucket].splice(i,1); state.todos[dest].push(t); store.save(); renderTodos(); }
      });
      delBtn.addEventListener('click', ()=>{
        if(confirm('Delete this task?')){ state.todos[activeBucket].splice(i,1); store.save(); renderTodos(); }
      });
      list.appendChild(el);
    });
  }
  addTodoDnDHandlers();
}
document.querySelector('.section-tabs').addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-bucket]'); if(!b) return;
  activeBucket = b.dataset.bucket; renderTodos();
});
document.getElementById('add-todo').addEventListener('click', ()=>{
  const text = document.getElementById('todo-text').value.trim();
  const cat = document.getElementById('todo-cat').value;
  if(!text) return;
  state.todos[activeBucket].push({ id:crypto.randomUUID(), text, cat, done:false, created: Date.now() });
  document.getElementById('todo-text').value=''; store.save(); renderTodos();
});
document.getElementById('todo-text').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('add-todo').click(); });

/* Drag & Drop handlers */
let dragSrc = null;
function addTodoDnDHandlers() {
  document.querySelectorAll('#todo-list .todo').forEach(el => {
    el.addEventListener('dragstart', e => {
      dragSrc = { idx: Number(el.dataset.index) };
      try{ e.dataTransfer.setData('text/plain', el.dataset.index); }catch(e){}
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', () => { dragSrc = null; el.classList.remove('dragging'); });
    el.addEventListener('dragover', e => e.preventDefault());
    el.addEventListener('drop', e => {
      e.preventDefault();
      if (!dragSrc) return;
      const from = dragSrc.idx;
      const to = Number(el.dataset.index);
      if (from === to) return;
      const arr = state.todos[activeBucket];
      const [moved] = arr.splice(from, 1);
      arr.splice(to, 0, moved);
      store.save(); renderTodos();
    });
  });
  document.querySelectorAll('.section-tabs button[data-bucket]').forEach(pill => {
    pill.addEventListener('dragover', e => e.preventDefault());
    pill.addEventListener('drop', e => {
      e.preventDefault();
      if (!dragSrc) return;
      const sourceArr = state.todos[activeBucket];
      const [moved] = sourceArr.splice(dragSrc.idx, 1);
      const dest = pill.dataset.bucket;
      state.todos[dest].push(moved);
      activeBucket = dest;
      store.save(); renderTodos();
    });
  });
}

/* --------- Schedule ---------- */
function defaultTimes(){
  const now = new Date();
  const start = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
  const endMin = Math.min(timeToMinutes(start)+60, 23*60+59);
  return { start, end: minutesToTime(endMin) };
}
function renderSchedule(dateStr){
  const grid = document.getElementById('schedule-grid'); grid.innerHTML='';
  const blocks = (state.schedule[dateStr]||[]).slice().sort((a,b)=>timeToMinutes(a.start)-timeToMinutes(b.start));
  if(!blocks.length){
    const empty = document.createElement('div');
    empty.className='card small muted';
    empty.textContent='No blocks yet. Add one above.';
    grid.appendChild(empty);
    return;
  }
  blocks.forEach((b,idx)=>{
    const el = document.createElement('div');
    el.className='block';
    el.style.borderLeftColor = getComputedStyle(document.documentElement).getPropertyValue('--cat-'+categoryClass(b.cat)).trim() || 'var(--accent-strong)';
    el.innerHTML = `
      <div class="row">
        <div class="grow"><strong>${b.title}</strong><div class="small muted">${b.start}–${b.end}</div></div>
        <span class="badge ${categoryClass(b.cat)}">${b.cat[0].toUpperCase()+b.cat.slice(1)}</span>
        <button title="Edit" type="button">✎</button>
        <button title="Delete" type="button">✕</button>
      </div>
    `;
    const [ , , editBtn, delBtn] = el.querySelectorAll('.grow, .badge, button, button');
    editBtn.addEventListener('click', ()=>{
      const title = prompt('Title', b.title) ?? b.title;
      const start = prompt('Start (HH:MM)', b.start) ?? b.start;
      const end   = prompt('End (HH:MM)', b.end) ?? b.end;
      b.title = title; b.start = start; b.end = end; store.save(); renderSchedule(dateStr);
    });
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this block?')){ state.schedule[dateStr].splice(idx,1); store.save(); renderSchedule(dateStr); }
    });
    grid.appendChild(el);
  });
}
function addBlock(){
  const title = document.getElementById('sched-title').value.trim(); if(!title) return;
  const date = document.getElementById('sched-date').value || todayISO();
  const start = document.getElementById('sched-start').value || defaultTimes().start;
  const end = document.getElementById('sched-end').value || defaultTimes().end;
  const cat = document.getElementById('sched-cat').value;
  const block = { id:crypto.randomUUID(), title, date, start, end, cat };
  state.schedule[date] ??= [];
  const newStart = timeToMinutes(start), newEnd = timeToMinutes(end);
  let conflict = false;
  for(const b of state.schedule[date]){
    const s = timeToMinutes(b.start), e = timeToMinutes(b.end);
    if(Math.max(s,newStart) < Math.min(e,newEnd)){ conflict = true; break; }
  }
  document.getElementById('collision-msg').style.display = conflict ? 'block' : 'none';
  state.schedule[date].push(block); store.save();
  document.getElementById('sched-title').value='';
  document.getElementById('sched-date-view').value = date;
  renderSchedule(date);
}
document.getElementById('add-block').addEventListener('click', addBlock);
document.getElementById('today-btn').addEventListener('click', ()=>{ document.getElementById('sched-date-view').value = todayISO(); renderSchedule(todayISO()); });
document.getElementById('clear-day').addEventListener('click', ()=>{
  const d = document.getElementById('sched-date-view').value || todayISO();
  if(!state.schedule[d]?.length) return;
  if(confirm('Delete all blocks for this day?')){ state.schedule[d] = []; store.save(); renderSchedule(d); }
});

/* --------- Habits ---------- */
function weekKey(d=new Date()){
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const day = (dt.getUTCDay()+6)%7; 
  dt.setUTCDate(dt.getUTCDate()-day);
  const year = dt.getUTCFullYear();
  const jan1 = new Date(Date.UTC(year,0,1));
  const week = Math.floor((dt-jan1)/ (7*24*3600*1000)) + 1;
  return `${year}-W${String(week).padStart(2,'0')}`;
}
function renderHabits(){
  const list = document.getElementById('habit-list'); list.innerHTML='';
  if(!state.habits.length){
    const empty = document.createElement('div'); empty.className='card small muted';
    empty.textContent='No habits yet. Add one above.';
    list.appendChild(empty); return;
  }
  const today = new Date();
  const week = weekKey(today);

  state.habits.forEach((h,i)=>{
    h.weeks ??= {}; h.weeks[week] ??= {days:[false,false,false,false,false,false,false], goal:h.goal||5};
    const data = h.weeks[week];
    const sum = data.days.filter(Boolean).length;
    const hitGoal = sum >= (data.goal||5);
    let streak = 0;
    let cur = new Date(today);
    while(true){
      const wk = weekKey(cur);
      const w = h.weeks[wk];
      if(w && w.days.filter(Boolean).length >= (w.goal||5)){ streak++; cur.setDate(cur.getDate()-7); }
      else break;
    }
    const el = document.createElement('div');
    el.className='habit';
    el.innerHTML = `
      <div class="grow">
        <strong>${h.name}</strong>
        <div class="small muted">Goal ${data.goal}/wk • <span class="streak">${streak} wk streak</span>${hitGoal?' ✅':''}</div>
      </div>
      <div class="days" role="group" aria-label="Week checks Mon–Sun"></div>
      <button title="Edit" type="button">✎</button>
      <button title="Delete" type="button">✕</button>
    `;
    const daysWrap = el.querySelector('.days');
    for(let d=0; d<7; d++){
      const btn = document.createElement('button');
      btn.className='daycheck';
      btn.setAttribute('aria-checked', String(data.days[d]));
      btn.textContent = 'MTWTFSS'[d];
      btn.addEventListener('click', ()=>{
        data.days[d] = !data.days[d]; btn.setAttribute('aria-checked', String(data.days[d]));
        store.save(); renderHabits();
      });
      daysWrap.appendChild(btn);
    }
    const [editBtn, delBtn] = el.querySelectorAll('button[title]');
    editBtn.addEventListener('click', ()=>{
      const name = prompt('Habit name', h.name) ?? h.name;
      const goal = Number(prompt('Weekly goal (1–7)', h.goal || data.goal)) || (h.goal||data.goal);
      h.name = name; h.goal = Math.min(7, Math.max(1, goal));
      data.goal = h.goal; store.save(); renderHabits();
    });
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this habit?')){ state.habits.splice(i,1); store.save(); renderHabits(); }
    });
    list.appendChild(el);
  });
}
document.getElementById('add-habit').addEventListener('click', ()=>{
  const name = document.getElementById('habit-name').value.trim(); if(!name) return;
  const goal = Math.min(7, Math.max(1, Number(document.getElementById('habit-goal').value)||5));
  state.habits.push({ id:crypto.randomUUID(), name, goal, weeks:{} });
  document.getElementById('habit-name').value=''; store.save(); renderHabits();
});

/* --------- Import / Export / Reset ---------- */
document.getElementById('export-data').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `focushub-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
document.getElementById('import-data').addEventListener('click', async ()=>{
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'application/json';
  input.onchange = () => {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(!data.todos || !data.schedule || !Array.isArray(data.habits)) throw new Error('Invalid file');
        state = data; store.save(); initUI();
        alert('Imported successfully.');
      }catch(e){ alert('Import failed: '+e.message); }
    };
    reader.readAsText(file);
  };
  input.click();
});
document.getElementById('reset-all').addEventListener('click', ()=>{
  if(!confirm('This wipes all data. Continue?')) return;
  state = { todos:{today:[],short:[],long:[]}, schedule:{}, habits:[] };
  store.save(); initUI();
});

/* --------- Init ---------- */
function initUI(){
  document.getElementById('sched-date').value = todayISO();
  const t = defaultTimes(); document.getElementById('sched-start').value = t.start; document.getElementById('sched-end').value=t.end;
  document.getElementById('sched-date-view').value = todayISO();
  const q = parseQuery(); handleQuickAdd(q);
  renderTodos(); renderSchedule(todayISO()); renderHabits();
}
initUI();

// PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js'));
}
</script>
</body>
</html>
